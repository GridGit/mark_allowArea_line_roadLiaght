
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>车道线</title>
<style>
body{margin:0;padding:0;}
.wrap{
    width: 
}
.canvas_content{

	width: 700px;
	height: 600px;
	float: left;
	margin: 20px;
}
.canvas{
    background:#ddd;
    position: absolute;
}
button{
	border: none;
	border-radius: 5px;
	cursor: pointer;
}
.operate{
	width: 300px;
	margin-top: 20px;
	float: left;
}
.operate div{
	margin-top: 20px;
	height: 40px;
}
.operate_title,.operate_start,.del{
	padding-bottom: 10px;
	border-bottom: 1px solid gray;
}
#prev,#next{
	width: 70px;
	height: 40px;
	background-color: rgb(24, 194, 153);
}
#draw_start,#save,#del_last{
	width: 70px;
	height: 40px;
	background-color: rgb(192, 216, 29);
}
.operate_type button{
	width: 70px;
	height: 40px;
	margin-top: 10px;
	background-color: rgb(18, 194, 128)
}
.operate_area{
	border-bottom: 1px solid gray;
}
</style>
</head>

<body>
<div class="wrap">
    <div id="canvas_content" class="canvas_content">
        <canvas id="canvas" class="canvas" width="700" height="600" ></canvas>
        <canvas id="canvas2" class="canvas" width="700" height="600" style="pointer-events: none;background-color: rgba(0,0,0,0);"></canvas>
    </div>
	
    <div class="operate">
	    <div class="file">
		    <input type='file' multiple id="file_list" class="file_list" accept="image/*"\>
		</div>
        <div id="operate_title" class="operate_title">
            <button id="prev" class="prev">上一张</button>
            <button id="next" class="next">下一张</button>
        </div>
        <div id="operate_start" class="operate_start">
        	<button id="draw_start" class="draw_start">开始画线</button>
        	<button id="del_last" class="del_last">删除线</button>
        	<button id="save" class="save">保存</button>
        </div>
        <div class="operate_area" id="operate_area" style="display: none;">
        	<div>请选择车道线类型：</div>     	
        	<div class="full_dot">
        		<label>实线/虚线</label>
				<select id="full_dot_select">
					<option value="0">---</option>
					<option value="fulledLine">实线</option>
					<option value="dottedLine">虚线</option>
				</select>                  
			</div>
			<div class="single_double" >
				 <label>单线/双线</label>
				 <select id="single_double_select">
				 	<option value="0">---</option>
				 	<option value="singleLine">单线</option>
				 	<option value="doubleLine">双线</option>
				 </select>				
			</div>	
			<div class="line_color" >
				<label>白色/黄色/不确定</label>
				<select id="color_select">
					<option value="0" >---</option>
					<option value="white">白色</option>
					<option value="yellow">黄色</option>
					<option value="unknown">不确定</option>
				</select>
			</div>
			<div class="operate_type">
				<button id="draw_dot" class="draw_dot">画线</button>
				<button id="draw_drag" class="draw_drag">拖动</button>
				<button id="draw_del" class="draw_del">删除点</button>
				<button id="draw_finish" class="draw_finish">完成</button>
				<button id="draw_return" class="draw_return">返回</button>
			</div>	 
        </div>        
    </div>
</div>


<script type="text/javascript" src='./jquery.min.js'></script>
<script>
;~function(){
    // global variables
    var canvas = document.getElementById("canvas"),
        canvas2 = document.getElementById('canvas2'),
        bg_img,
        img_src = "",
        fileInput = $(".file_list")[0],
        prev_but = $(".prev"),
        next_but = $(".next"),
        
        operate_start = $('.operate_start'),
        draw_start = $('.draw_start'),
        del_last = $('.del_last'),
        save_but = $(".save"),
       
        operate_area = $('.operate_area'),

       	full_dot_select = $('#full_dot_select'),
       	single_double_select = $('#single_double_select'),
       	color_select = $('#color_select'),

       	draw_dot = $('.draw_dot'),
       	draw_drag = $('.drag_drag'),
       	draw_del = $('.draw_del'),
       	draw_finish = $('.draw_finish'),
       	draw_return = $('.draw_return'),

        draw_state = false,
        drag_state = true;

    var line_colors = ['rgba(233, 27, 27, 0.5)', 'rgba(	233, 153, 27, 0.5)', 'rgba(	233, 231, 27, 0.5)', 'rgba(	102, 233, 27, 0.5)', 'rgba(	27, 233, 226, 0.5)', 'rgba(	27, 114, 233, 0.5)', 'rgba(	102, 27, 233, 0.5)'];


   	DragGraph = function(x, y, w, h, fillStyle, canvas, graphShape = 'circle', strokeStyle = 'rgba(255, 0, 0, 0.3)') {
	        this.x = x;
	        this.y = y;
	        this.w = w;
	        this.h = h;
	        this.fillStyle = fillStyle || strokeStyle;
	        this.strokeStyle = strokeStyle;
	        this.canvas = canvas;
	        this.context = canvas.getContext("2d");
	        this.graphShape = graphShape;
	    }

    DragGraph.prototype = {
    	// 绘制
        paint : function(){
            this.context.beginPath();
            this.context.fillStyle = this.fillStyle;
            this.shapeDraw();
            this.context.fill();
            this.context.closePath();
        },
        // 鼠标是否在点上，用于判断，是否能结束绘制
        isMouseInGraph : function(mouse){
            var d = (mouse.x - this.x) ** 2 + (mouse.y - this.y) ** 2;
            return d <= 25;
        },
        // 绘制点的外形
        shapeDraw : function(){
            if (this.graphShape == "circle"){
                this.context.arc(this.x , this.y , 2.5, 0 , Math.PI*2);
            } else if (this.graphShape == "triangle"){
                this.context.moveTo(this.x + 50 , this.y + 50); 
                this.context.lineTo(this.x + 100 , this.y + 130); 
                this.context.lineTo(this.x , this.y + 130);
            } else {
                this.context.rect( this.x , this.y , this.w , this.h);
            }
        }, 
        // 移动
        move: function(deltax, deltay){
        	this.x = this.x + deltax;
        	this.y = this.y + deltay;
        },
        // 清除
        erase: function() {
            this.context.clearRect(0,0,this.canvas.width,this.canvas.height);
        },
        // 重新调整尺寸
        resize: function(mouse, delta) {
            var ratio = 1 + delta / 15.0;
            ratio = ratio > 0 ? ratio : 1;
            cx = mouse.x - this.x;
            cy = mouse.y - this.y;
            this.x = mouse.x - cx * ratio;
            this.y = mouse.y - cy * ratio;
        }
    }

	var DrawLine = function(canvas){
		this.canvas = canvas;
		this.context = canvas.getContext('2d');
		this.laneStyle;
		this.laneType;
		this.laneColor;
		this.color = 'rgb(255, 0, 0)';
		this.currPoint;
		this.mouse;
		this.points = [];
	}
	DrawLine.prototype = {
		paint: function(){
			if(this.points.length === 0){
				return;
			}
			this.drawLine();
			for(var i = 0; i < this.points.length; i++){
				this.points[i].paint();
			}
		},
		drawLine: function(){
			var pt = this.points;
			this.context.save();
			this.context.beginPath();
			this.context.moveTo(pt[0].x, pt[0].y);
			for(var i = 1; i < pt.length; i++){
				this.context.lineTo(pt[i].x, pt[i].y);
			}
			if(this.mouse){
				this.context.lineTo(this.mouse.x, this.mouse.y);
			}
			this.context.strokeStyle = this.color;
			this.context.lineWidth = 3;
			this.context.stroke();
			this.context.closePath();

		},
		addPoint: function(point){
			this.currPoint = point;
			this.points.push(point);

		},
		isDrawDone: function(mouse){
			if(this.points.length === 0){
				return false;
			}
			return this.points[this.points.length - 1].isMouseInGraph(mouse);
		},
		move: function(deltax, deltay){
			this.points.forEach(function(item){
				item.move(deltax, deltay);
			})
		},
		resize: function(mouse, delta){
			var ratio = 1 + delta / 15.0;
            ratio = ratio > 0 ? ratio : 1;
			for(var i = 0; i < this.points.length; i++){
				this.points[i].resize(mouse, delta);
			}
		}
	}
    DragRect = function(left, top, right, bottom, canvas, color = '#FF0000') {
        this.left = left;
        this.top = top;
        this.right = right;
        this.bottom = bottom;
        this.color = color
        this.canvas = canvas;
        this.name = '';
        this.type = 0;
        this.text = '';
        this.selected = false;
        this.context = canvas.getContext("2d");
    }

    DragRect.prototype = {
        paint: function() {
            this.context.beginPath();
            this.context.moveTo(this.left, this.top);
            this.context.lineTo(this.right, this.top);
            this.context.lineTo(this.right, this.bottom);
            this.context.lineTo(this.left, this.bottom);
            this.context.lineTo(this.left, this.top);
            this.context.strokeStyle = this.color;
            if (this.selected) {
                this.context.fillStyle = this.color;
                this.context.fill();
            }
            this.context.lineWith = 3;
            this.context.stroke();
        },
        resize: function(mouse, delta) {
            var ratio = 1 + delta / 15.0;
            ratio = ratio > 0 ? ratio : 1;
            cl = mouse.x - this.left;
            ct = mouse.y - this.top;
            cr = mouse.x - this.right;
            cb = mouse.y - this.bottom;
            this.left = mouse.x - cl * ratio;
            this.top = mouse.y - ct * ratio;
            this.right = mouse.x - cr * ratio;
            this.bottom = mouse.y - cb * ratio;
        },
        fitCanvas: function(ratio, dx, dy) {
            this.left = this.left / ratio + dx;
            this.top = this.top / ratio + dy;
            this.right = this.right / ratio + dx;
            this.bottom = this.bottom / ratio + dy;
        },
        isMouseInRect: function(mouse){
            return mouse.x > this.left && mouse.x < this.right
                    && mouse.y > this.top && mouse.y < this.bottom;
        }
    }

    DragImage = function(src, canvas) {
        this.img = new Image();
        this.img.src = src;
        this.canvas = canvas;
        this.context = canvas.getContext("2d");
        this.rects = [];
        this.currRect;

        this.lines = [];
    	this.currLine;

        this.selectRect;
        this.currColor;
        this.currName;
        this.currType;
        var that = this;
        this.img.onload = function() {
            that.x = 0;
            that.y = 0;
            that.width = that.img.width;
            that.height = that.img.height;
            that.fitCanvas();
            that.paint();
        };
    }

    DragImage.prototype = {
        paint: function(){
            this.context.drawImage(this.img, this.x, this.y, this.width, this.height);

            this.rects.forEach(function(r){
                r.paint();
            });
            this.lines.forEach(function(item){
            	item.paint();
            });

            // this.currLine.paint();


        },
        toggle_current_point_visiblility: function(index) {
            this.landmarks[index].visibility = !this.landmarks[index].visibility;
        },
        isMouseInImage: function(mouse){
            var out = mouse.x < this.x || mouse.y < this.y ||
                      mouse.x >= this.x + this.width || mouse.y >= this.y + this.height;
            return !out;
        },
        erase: function() {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
        move: function(deltax, deltay){
        	this.x = this.x + deltax;
        	this.y = this.y + deltay;

        	this.lines.forEach(function(item){
        		item.move(deltax, deltay);
        	});
        },
        resize: function(mouse, delta) {
            var ratio = 1 + delta / 15.0;
            ratio = ratio > 0 ? ratio : 1;
            cx = mouse.x - this.x;
            cy = mouse.y - this.y;
            this.x = mouse.x - cx * ratio;
            this.y = mouse.y - cy * ratio;
            this.width = this.width * ratio;
            this.height = this.height * ratio;

            this.rects.forEach(function(r){
                r.resize(mouse, delta);
            });
            this.lines.forEach(function(item){
            	item.resize(mouse, delta);
            })
        },
        getRatio: function() {
            if (this.img.width / this.img.height > canvas.width / canvas.height) {
                return this.img.width / canvas.width;
            } else {
                return this.img.height / canvas.height;
            }
        },
        fitCanvas: function() {
            var ratio = this.getRatio();
            var dx = 0, dy = 0;
            if (this.img.width / this.img.height > canvas.width / canvas.height) {
                dy = (canvas.height - this.height / ratio) / 2;
            } else {
                dx = (canvas.width - this.width / ratio) / 2;
            }
            this.width = this.width / ratio;
            this.height = this.height / ratio;
            this.x = dx;
            this.y = dy;

            this.rects.forEach(function(r){
                r.fitCanvas(ratio, dx, dy);
            });
            this.lines.forEach(function(item){
            	item.fitCanvas(ratio, dx, dy)
            });
        },
        get_coordinates_json_str: function(name) {
           	this.lines
            var json = {};
            json.name = name;
            json.data = {};
            json.data.lines = [];
            
            for(var i = 0; i < this.lines.length; i++){
            	var item = {};
            	item.laneStyle = this.lines[i].laneStyle;
            	item.laneType = this.lines[i].laneType;
            	item.laneColor = this.lines[i].laneColor;
            	item.points = [];
            	for(var j = 0; j < this.lines[i].points.length; j++){
            		var p = {};
            		p.x = ((this.lines[i].points[j].x - this.x) / this.width * this.img.width);
            		p.y = ((this.lines[i].points[j].y - this.y) / this.height * this.img.height);
            		item.points.push(p)
            	}
            	json.data.lines.push(item);	
            }         
            return JSON.stringify(json);
        }
    }
   
    function saveData() {

    	if(fileInput.files.length === 0){
			alert('请选择图片...');
			return;
		}

        if (bg_img.lines.length == 0) {
            alert('还没有画线呢。。。');
            return;
        }
        
        saveCoordinates();
    }

    function saveCoordinates() {
        var text = bg_img.get_coordinates_json_str(fileInput.files[file_idx].name);
        var data = new Blob([text], {type: "text/plain"});
        textFile = window.URL.createObjectURL(data);
        var link = document.createElement('a');
        var fileName = fileInput.files[file_idx].name + '.txt';
        link.setAttribute('download', fileName);
        link.href = textFile;
        document.body.appendChild(link);
        // wait for the link to be added to the document
        window.requestAnimationFrame(function () {
            var event = new MouseEvent('click');
            link.dispatchEvent(event);
            document.body.removeChild(link);
        });
    }
    // 选择文件
    $(fileInput).on('change', function () {
        file_idx = 0;
        loadData();
    });
    function loadData() {
        var fileName = fileInput.files[file_idx].name;
        var len = fileName.length;
        if (fileName.slice(len - 4, len) != '.jpg'
                && fileName.slice(len - 5, len) != '.jpeg'
                && fileName.slice(len - 4, len) != '.png') {
            return;
        }

        img_src = fileInput.files[file_idx].name;
        bg_img = new DragImage(img_src, canvas);
        bg_img.erase();
        bg_img.paint();
        canvas.style.cursor = 'pointer';
    }

   	// 开始画线
    draw_start.on('click', drawStart)
    function drawStart(e){
    	e.stopPropagation();
		e.preventDefault();
		
		if(fileInput.files.length === 0){
			alert('请选择图片');
			return;
		}

		// 初始化 line对象，每次点击，绘制一条新线
    	bg_img.currLine = new DrawLine(canvas);
		bg_img.lines.push(bg_img.currLine);

		full_dot_select.val('0');
		single_double_select.val('0');
		color_select.val('0');

		operate_area.slideDown();
		operate_start.slideUp();
    }

    // 删除线
   	del_last.on('click', delLast)
  	function delLast(e){
  		e.stopPropagation();
  		e.preventDefault();

  		if(fileInput.files.length === 0){
			alert('请选择图片...');
			return;
		}
		
        if (bg_img.lines.length == 0) {
            alert('还没有画线呢。。。');
            return;
        }
  		bg_img.lines.pop();
  		bg_img.currLine = null;
  		bg_img.erase();
  		bg_img.paint();
  	}
  	// 保存
  	save_but.on('click', saveBut)
  	function saveBut(e){
  		e.stopPropagation();
  		e.preventDefault();
  		saveData();
  	}
  
    full_dot_select.on('change', fullDotSelect);
    function fullDotSelect(e){
    	e.stopPropagation();
    	e.preventDefault();

    	resetCurrLineColor()
    }
    single_double_select.on('change', singDoubleSelect);
    function singDoubleSelect(e){
    	e.stopPropagation();
    	e.preventDefault();

    	resetCurrLineColor();
    }
    color_select.on('change', colorSelect);
    function colorSelect(e){
    	e.stopPropagation();
    	e.preventDefault();

    	resetCurrLineColor();
    }
    // 开始标点
    draw_dot.on('click', drawDot)
    function drawDot(e){
    	e.stopPropagation();
    	e.preventDefault();

    	draw_state = true;
    	drag_drag = false;

    	canvas.addEventListener('mousemove', mouseMoveDrawAssistLine,false);
	    
	    function mouseMoveDrawAssistLine(e){
	    	var mouse = {
	            x : e.clientX - canvas.getBoundingClientRect().left,
	            y : e.clientY - canvas.getBoundingClientRect().top
	        };
	        if(bg_img && canvas){
	        	if(bg_img.isMouseInImage(mouse)){
	        		// canvas.style.cursor = 'crosshair';

	        		var left = e.clientX - canvas.getBoundingClientRect().left;
		            var top = e.clientY - canvas.getBoundingClientRect().top;
		            var ctx = canvas2.getContext("2d");
		            ctx.clearRect(0, 0, canvas2.width, canvas2.height);
		            // 开始绘制 标线
		            ctx.strokeStyle="gray";
		            ctx.beginPath();
		            ctx.moveTo(left-canvas2.width, top);
		            ctx.lineTo(left+canvas2.width, top);
		            ctx.moveTo(left, top-canvas2.height);
		            ctx.lineTo(left, top+canvas2.height);
		            ctx.stroke();
		            ctx.closePath();

		            canvas.addEventListener('mouseout', mouseoutClearMousemove, false)
		            function mouseoutClearMousemove(e){
		            	ctx.clearRect(0, 0, canvas2.width, canvas2.height)
		            }
	        	}
	        	if(!bg_img.isMouseInImage(mouse)){
	        		var ctx = canvas2.getContext('2d');
	        		canvas.style.cursor = 'pointer';

	        		ctx.clearRect(0, 0, canvas2.width, canvas2.height)
	        	}  
	        }
	    }
    }
    // 拖动
    draw_drag.on('click', drawDrag);
    function drawDrag(e){
    	e.stopPropagation();
    	e.preventDefault();

    	draw_state = false;
    	drag_state = true;
    }
    // 删除点
    draw_del.on('click', drawDel);
    function drawDel(e){
    	e.stopPropagation();
    	e.preventDefault();

    	if(bg_img.currLine == null){
    		bg_img.lines.pop()
    	}else {
    		bg_img.currLine.points.pop();
    		if(bg_img.currLine.points.length == 0){
    			bg_img.lines.pop()
    		}
    	}
    	bg_img.erase();
    	bg_img.paint();
    }
    // 完成
    draw_finish.on('click', drawFinish);
   	function drawFinish(e){
   		e.stopPropagation();
   		e.preventDefault();

   		if(full_dot_select.val() == 0 ){
			alert('请选择实线或虚线。。。');
			return;
		}
		if(single_double_select.val() == 0){
			alert('请选择单线或双线。。。');
			return;
		}
		if(color_select.val() == 0){
			alert('请选择颜色。。。');
			return;
		}


		 bg_img.lines[bg_img.lines.length - 1].laneStyle = full_dot_select.val();
		 bg_img.lines[bg_img.lines.length - 1].laneType = single_double_select.val();
		 bg_img.lines[bg_img.lines.length - 1].laneColor = color_select.val();


	    resetCurrLineColor();

	    if(bg_img.currLine) {
	        if(bg_img.currLine.mouse) {
	           bg_img.currLine.mouse = null;
	        }
	        bg_img.currLine = null;
	    }
	    bg_img.erase();
	    bg_img.paint();

        draw_state = false;
        drag_state = true;
  
        console.log(bg_img)

   		operate_area.slideUp();
		operate_start.slideDown();
   	}
   	
   	// 重新设置当前物体颜色
	function resetCurrLineColor(){
		var color;
      	if(parseInt(full_dot_select.val()) != 0  && parseInt(single_double_select.val()) != 0 && parseInt(color_select.val()) != 0){
      		var a = full_dot_select.val();
      		var b = single_double_select.val();
      		var c = color_select.val();

      		if(c == 'white' && b == 'singleLine' &&  a == 'fulledLine'){
      			color = 'red'; //红
      		}else if(c == 'white' && b == 'singleLine' && a == 'dottedLine'){
      			color = 'green'; //绿
      		}else if(c == 'white' && b == 'doubleLine' && a == 'fulledLine'){
      			color = 'yellow' // 黄
      		}else if(c == 'white' && b == 'doubleLine' && a == 'dottedLine'){
      			color = 'orange' //橙
      		}else if(c == 'yellow' && b == 'singleLine' && a == 'fulledLine'){
      			color = 'blue'; //蓝
      		}else if(c == 'yellow' && b == 'singleLine' && a == 'dottedLine'){
      			color = 'rgb(60, 119, 21)' //暗紫
      		}else if(c == 'yellow' && b == 'doubleLine' && a == 'dottedLine'){
      			color = 'rgb(105, 235, 19)'; //青
      		}else if (c == 'yellow' && b == 'doubleLine' && a == 'fulledLine') {
      			color = 'rgb(14, 30, 212)' //紫
      		}else if(c == 'unknown' && b == 'doubleLine' && a == 'fulledLine'){
      			color = 'rgb(158, 161, 117)'; //暗黄
      		}else if(c == 'unknown' && b == 'doubleLine' && a == 'dottedLine'){
      			color = 'rgb(16, 214, 208)';//天蓝
      		}else if(c == 'unknown' && b == 'singleLine' && a == 'fulledLine'){
      			color = 'rgb(168, 83, 24)'; //暗红
      		}else if(c == 'unknown' && b == 'singleLine' && a == 'dottedLine'){
      			color ='rgb(31, 31, 36)' //黑
      		}

      	}
      	if(bg_img.currLine){
      		bg_img.currLine.color = color;
      	}else{
      		bg_img.lines[bg_img.lines.length - 1].color = color;
      	}
        bg_img.erase();
        bg_img.paint();
	}
    // 返回
    draw_return.on('click', drawReturn);
    function drawReturn(e){
    	e.stopPropagation();
    	e.preventDefault();


    	if(bg_img.currLine){
    		if(bg_img.currLine.mouse){
    			bg_img.currLine.mouse = null
    		}
    		bg_img.currLine = null
    	}
    	bg_img.lines.pop();
    	bg_img.erase();
    	bg_img.paint();

    	draw_state = false;
    	drag_state = true;

    	operate_area.slideUp();
		operate_start.slideDown();
    }
    // 上一张
    prev_but.on('click', prevBut)
    function prevBut(e){
    	e.stopPropagation();
    	e.preventDefault();

    	if (!fileInput.value) {
            alert('没有选择标注文件');
            return;
        }
        if (file_idx <= 0) {
            alert('已经是第一张');
            return;
        } else {
            // saveData();
            --file_idx;
            loadData();
        }
    }
    // 下一张
   	next_but.on('click', nextBut);
   	function nextBut(e){
   		e.stopPropagation();
   		e.preventDefault();

   		if (!fileInput.value) {
            alert('没有选择标注文件');
            return;
        }
        if (file_idx >= fileInput.files.length-1) {
            alert('已经是最后一张');
            return;
        } else {
            // saveData();
            ++file_idx;
            loadData();
        }
   	}
 
    var mouseStart = {};

    canvas.addEventListener( "mousedown" , function(e){
    	e.stopPropagation();
    	e.preventDefault();

    	var mouse = {
	        x : e.clientX - canvas.getBoundingClientRect().left,
	        y : e.clientY - canvas.getBoundingClientRect().top
	    };
	    mouseStart.x = mouse.x;
	    mouseStart.y = mouse.y
	    if(bg_img.isMouseInImage(mouse)){  	
	    	if (draw_state) {
	    		
	    		canvas.style.cursor = 'crosshair';

	    		// 如果当前存在正在绘制的线段	    		
	    		if(!bg_img.currLine){
	    			return;
	    		}
	    		if(bg_img.currLine.isDrawDone(mouse)){
	    			bg_img.currLine.mouse = null;
	    			bg_img.currLine = null;
	    			bg_img.erase();
	    			bg_img.paint();

	    			draw_state = false;
	    			canvas.style.cursor = 'pointer';
	    			return; 
	    		}
	    		// 新建 点
    			var p = new DragGraph(mouse.x, mouse.y, 0, 0, "rgba(0, 255, 0, 0.7)", canvas, "circle", "#00FF00"); 
    			// 将此点设为当前线段的最新点，并加入points数组
    			bg_img.currLine.currPoint = p
    			bg_img.currLine.points.push(p);
    			// 重绘，绘制最先新点
    			bg_img.erase();
    			bg_img.paint();

	            canvas.addEventListener("mousemove" , mouseMoveDraw, false);
	            function mouseMoveDraw(e){
	            	e.stopPropagation();
	            	e.preventDefault();

	            	var mouse = {
				        x : e.clientX - canvas.getBoundingClientRect().left,
				        y : e.clientY - canvas.getBoundingClientRect().top
				    };

				    if(bg_img.currLine){
				    	bg_img.currLine.mouse = mouse;
				   	 	bg_img.erase();
				    	bg_img.paint();
				    }
	            }
	            canvas.addEventListener("mouseout", function(e) {
	                canvas.removeEventListener("mousemove", mouseMoveDraw, false);
	            }, false);
	        } else if(drag_state){
	        		
	        		canvas.addEventListener('mousemove', mouseMoveChangePoint, false);
	        		function mouseMoveChangePoint(e){
	        			e.stopPropagation();
	        			e.preventDefault();

	        			var loc = {
	        				x: e.clientX - canvas.getBoundingClientRect().left,
	        				y: e.clientY - canvas.getBoundingClientRect().top
	        			}
	        			var deltax = loc.x - mouseStart.x;
	        			var deltay = loc.y - mouseStart.y;
	        			mouseStart.x = loc.x;
	        			mouseStart.y = loc.y;

	        			bg_img.move(deltax, deltay);
	        			bg_img.erase();
	        			bg_img.paint();

	        		}
	        		canvas.addEventListener('mouseup', mouseUpCancelMousemove, false);
	        		function mouseUpCancelMousemove(e){
	        			e.stopPropagation();
	        			e.preventDefault();

	        			canvas.removeEventListener('mousemove', mouseMoveChangePoint, false);
	        		}
	                canvas.addEventListener("mouseout", function(e){
	                    mouse_up = true;
	                    canvas.removeEventListener("mousemove", mouseMoveChangePoint, false);
	                }, false);
	            }
	    } 
    } , false);


	// 鼠标滚轮缩放
    canvas.addEventListener("DOMMouseScroll" , function(e){
        var mouse = {
            x : e.clientX - canvas.getBoundingClientRect().left,
            y : e.clientY - canvas.getBoundingClientRect().top
        };
        if (bg_img.isMouseInImage(mouse)) {
            bg_img.resize(mouse, -e.detail);
            bg_img.erase();
            bg_img.paint();
            e.preventDefault();
        }
        // console.log(e.detail);
    }, false);

    canvas.addEventListener("mousewheel" , function(e){
        var mouse = {
            x : e.clientX - canvas.getBoundingClientRect().left,
            y : e.clientY - canvas.getBoundingClientRect().top
        };
        if (bg_img.isMouseInImage(mouse)) {
            bg_img.resize(mouse, e.wheelDelta / 120.0);
            bg_img.erase();
            bg_img.paint();
            e.preventDefault();
        }
        // console.log(e.wheelDelta);
    }, false);

}()
</script>

</body>
</html>


